<Activity mc:Ignorable="sap" x:Class="WFWorkerRole.UpdateFilesList" sap:VirtualizedContainerService.HintSize="592,1677" mva:VisualBasic.Settings="Assembly references and imported namespaces for internal implementation" xmlns="http://schemas.microsoft.com/netfx/2009/xaml/activities" xmlns:maac="clr-namespace:Microsoft.Activities.Azure.Caching;assembly=Microsoft.Activities.Azure" xmlns:maasb="clr-namespace:Microsoft.Activities.Azure.Storage.Blob;assembly=Microsoft.Activities.Azure" xmlns:maast="clr-namespace:Microsoft.Activities.Azure.Storage.Table;assembly=Microsoft.Activities.Azure" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:mv="clr-namespace:Microsoft.VisualBasic;assembly=System" xmlns:mva="clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities" xmlns:mws="clr-namespace:Microsoft.WindowsAzure.StorageClient;assembly=Microsoft.WindowsAzure.StorageClient" xmlns:p="http://schemas.microsoft.com/netfx/2009/xaml/servicemodel" xmlns:s="clr-namespace:System;assembly=mscorlib" xmlns:s1="clr-namespace:System;assembly=System" xmlns:s2="clr-namespace:System;assembly=System.Xml" xmlns:s3="clr-namespace:System;assembly=System.Core" xmlns:s4="clr-namespace:SharedLib;assembly=SharedLib" xmlns:s5="clr-namespace:System;assembly=System.ServiceModel" xmlns:sa="clr-namespace:System.Activities;assembly=System.Activities" xmlns:sad="clr-namespace:System.Activities.Debugger;assembly=System.Activities" xmlns:sap="http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation" xmlns:scg="clr-namespace:System.Collections.Generic;assembly=System" xmlns:scg1="clr-namespace:System.Collections.Generic;assembly=System.ServiceModel" xmlns:scg2="clr-namespace:System.Collections.Generic;assembly=System.Core" xmlns:scg3="clr-namespace:System.Collections.Generic;assembly=mscorlib" xmlns:sd="clr-namespace:System.Data;assembly=System.Data" xmlns:sl="clr-namespace:System.Linq;assembly=System.Core" xmlns:st="clr-namespace:System.Text;assembly=mscorlib" xmlns:sx="clr-namespace:System.Xml;assembly=System.Xml" xmlns:sx1="clr-namespace:System.Xml;assembly=System.Data" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <Sequence DisplayName="Update File List Workflow" sap:VirtualizedContainerService.HintSize="552,1637">
    <sap:WorkflowViewStateService.ViewState>
      <scg3:Dictionary x:TypeArguments="x:String, x:Object">
        <x:Boolean x:Key="IsExpanded">True</x:Boolean>
      </scg3:Dictionary>
    </sap:WorkflowViewStateService.ViewState>
    <Sequence DisplayName="Initialize the cache item" sap:VirtualizedContainerService.HintSize="530,310">
      <Sequence.Variables>
        <Variable x:TypeArguments="scg3:IEnumerable(s4:FileEntity)" Name="fileEntities" />
        <Variable x:TypeArguments="scg3:IEnumerable(s4:FileInfo)" Name="fileInfos" />
      </Sequence.Variables>
      <sap:WorkflowViewStateService.ViewState>
        <scg3:Dictionary x:TypeArguments="x:String, x:Object">
          <x:Boolean x:Key="IsExpanded">True</x:Boolean>
        </scg3:Dictionary>
      </sap:WorkflowViewStateService.ViewState>
      <maast:QueryEntities x:TypeArguments="s4:FileEntity" DisplayName="Get all entities in the table" sap:VirtualizedContainerService.HintSize="242,22" Result="[fileEntities]" TableName="[SharedLib.StorageHelper.FilesTableName]">
        <maast:QueryEntities.QueryOptions>
          <scg3:Dictionary x:TypeArguments="x:String, InArgument(x:String)" />
        </maast:QueryEntities.QueryOptions>
      </maast:QueryEntities>
      <Assign DisplayName="Generate fileInfos from fileEntities" sap:VirtualizedContainerService.HintSize="242,62">
        <Assign.To>
          <OutArgument x:TypeArguments="scg3:IEnumerable(s4:FileInfo)">[fileInfos]</OutArgument>
        </Assign.To>
        <Assign.Value>
          <InArgument x:TypeArguments="scg3:List(s4:FileInfo)" xml:space="preserve">[(From e In fileEntities
	   Select (New FileInfo(e))).ToList()]</InArgument>
        </Assign.Value>
      </Assign>
      <maac:AddCacheItem DisplayName="Put them to the cache" sap:VirtualizedContainerService.HintSize="242,22" Key="[SharedLib.StorageHelper.FilesListCacheItemKey]" ReplaceExisting="True" Value="[New FilesListCacheItem(fileInfos)]" />
    </Sequence>
    <While DisplayName="Monitor newly updated file entities" sap:VirtualizedContainerService.HintSize="530,1163">
      <While.Variables>
        <Variable x:TypeArguments="s:DateTime" Default="[DateTime.UtcNow]" Name="checkPointTimestamp" />
      </While.Variables>
      <While.Condition>True</While.Condition>
      <TryCatch sap:VirtualizedContainerService.HintSize="504,1047">
        <TryCatch.Try>
          <Sequence sap:VirtualizedContainerService.HintSize="486,860">
            <Sequence.Variables>
              <Variable x:TypeArguments="scg3:IEnumerable(s4:FileEntity)" Name="newlyUpdatedEntities" />
              <Variable x:TypeArguments="s:DateTime" Name="currentTimestamp" />
            </Sequence.Variables>
            <sap:WorkflowViewStateService.ViewState>
              <scg3:Dictionary x:TypeArguments="x:String, x:Object">
                <x:Boolean x:Key="IsExpanded">True</x:Boolean>
              </scg3:Dictionary>
            </sap:WorkflowViewStateService.ViewState>
            <Delay DisplayName="Delay for a while" Duration="[TimeSpan.FromMinutes(1D)]" sap:VirtualizedContainerService.HintSize="464,22" />
            <Assign DisplayName="Get the current timestamp" sap:VirtualizedContainerService.HintSize="464,58">
              <Assign.To>
                <OutArgument x:TypeArguments="s:DateTime">[currentTimestamp]</OutArgument>
              </Assign.To>
              <Assign.Value>
                <InArgument x:TypeArguments="s:DateTime">[checkPointTimestamp]</InArgument>
              </Assign.Value>
            </Assign>
            <Assign DisplayName="Save the check point timestamp" sap:VirtualizedContainerService.HintSize="464,58">
              <Assign.To>
                <OutArgument x:TypeArguments="s:DateTime">[checkPointTimestamp]</OutArgument>
              </Assign.To>
              <Assign.Value>
                <InArgument x:TypeArguments="s:DateTime">[DateTime.UtcNow]</InArgument>
              </Assign.Value>
            </Assign>
            <maast:QueryEntities x:TypeArguments="s4:FileEntity" DisplayName="Query newer entities since the last timestamp" sap:VirtualizedContainerService.HintSize="464,22" Result="[newlyUpdatedEntities]" TableName="[SharedLib.StorageHelper.FilesTableName]">
              <maast:QueryEntities.QueryOptions>
                <InArgument x:TypeArguments="x:String" x:Key="$filter">[String.Format("Timestamp gt datetime'{0}'", System.Xml.XmlConvert.ToString(currentTimeStamp, System.Xml.XmlDateTimeSerializationMode.RoundtripKind))]</InArgument>
              </maast:QueryEntities.QueryOptions>
            </maast:QueryEntities>
            <If Condition="[0 &lt; newlyUpdatedEntities.Count()]" DisplayName="Whether there are updates available" sap:VirtualizedContainerService.HintSize="464,416">
              <If.Then>
                <Sequence DisplayName="Update the cache" sap:VirtualizedContainerService.HintSize="301,310">
                  <Sequence.Variables>
                    <Variable x:TypeArguments="scg3:IEnumerable(s4:FileEntity)" Name="fileEntities" />
                    <Variable x:TypeArguments="scg3:IEnumerable(s4:FileInfo)" Name="fileInfos" />
                  </Sequence.Variables>
                  <sap:WorkflowViewStateService.ViewState>
                    <scg3:Dictionary x:TypeArguments="x:String, x:Object">
                      <x:Boolean x:Key="IsExpanded">True</x:Boolean>
                    </scg3:Dictionary>
                  </sap:WorkflowViewStateService.ViewState>
                  <maast:QueryEntities x:TypeArguments="s4:FileEntity" DisplayName="Get all entities in the table" sap:VirtualizedContainerService.HintSize="242,22" Result="[fileEntities]" TableName="[SharedLib.StorageHelper.FilesTableName]">
                    <maast:QueryEntities.QueryOptions>
                      <scg3:Dictionary x:TypeArguments="x:String, InArgument(x:String)" />
                    </maast:QueryEntities.QueryOptions>
                  </maast:QueryEntities>
                  <Assign DisplayName="Generate fileInfos from fileEntities" sap:VirtualizedContainerService.HintSize="242,62">
                    <Assign.To>
                      <OutArgument x:TypeArguments="scg3:IEnumerable(s4:FileInfo)">[fileInfos]</OutArgument>
                    </Assign.To>
                    <Assign.Value>
                      <InArgument x:TypeArguments="scg3:IEnumerable(s4:FileInfo)" xml:space="preserve">[(From e In fileEntities
		  Select (New FileInfo(e))).ToList()]</InArgument>
                    </Assign.Value>
                  </Assign>
                  <maac:AddCacheItem DisplayName="Update the files list to the cache" sap:VirtualizedContainerService.HintSize="242,22" Key="[SharedLib.StorageHelper.FilesListCacheItemKey]" ReplaceExisting="True" Value="[New FilesListCacheItem(fileInfos)]" />
                </Sequence>
              </If.Then>
            </If>
          </Sequence>
        </TryCatch.Try>
        <TryCatch.Catches>
          <Catch x:TypeArguments="s:Exception" sap:VirtualizedContainerService.HintSize="490,21">
            <sap:WorkflowViewStateService.ViewState>
              <scg3:Dictionary x:TypeArguments="x:String, x:Object">
                <x:Boolean x:Key="IsExpanded">False</x:Boolean>
                <x:Boolean x:Key="IsPinned">False</x:Boolean>
              </scg3:Dictionary>
            </sap:WorkflowViewStateService.ViewState>
            <ActivityAction x:TypeArguments="s:Exception">
              <ActivityAction.Argument>
                <DelegateInArgument x:TypeArguments="s:Exception" Name="exception" />
              </ActivityAction.Argument>
              <Rethrow DisplayName="Process the exception" sap:VirtualizedContainerService.HintSize="484,75" />
            </ActivityAction>
          </Catch>
        </TryCatch.Catches>
      </TryCatch>
    </While>
  </Sequence>
</Activity>